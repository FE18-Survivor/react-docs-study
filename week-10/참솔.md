# Week 10

## [React Compiler - Introduction](https://react.dev/learn/react-compiler/introduction)

- Components 및 values를 수동으로 memoize 하면 실수하기 쉽고 유지보수할 코드가 증가함
- React compiler는 React app을 build-time에 자동으로 최적화하여, **최적화 부담을 줄이고 기능을 개발하는 데에 집중**할 수 있게 함
- React compiler를 사용하면 `memo`, `useMemo`, `useCallback` 등을 사용하지 않아도 됨
- React compiler는 re-rendering 성능을 향상시키는 것이 주요 목적이므로, 아래 두 가지 use case에 집중함
  1. **Skipping cascading re-rendering of components**
     - `<Parent />`만 변경되었음에도 component tree의 다른 component 들까지 re-render 되는 경우
     - State가 변경되었을 때 관련된 부분만 re-render 될 수 있도록, 수동으로 추가하던 memoization을 자동화
  2. **Skipping expensive calculations from outside of React**
     - 어떤 data를 필요로 하는 component 또는 hook에서 rendering 중에 실행되는 비싼 계산을 자동으로 memoize
     - 단, React compiler는 React components 및 hooks만 memoize 하고 다른 components 및 hooks와 memoization을 공유하지 않으므로 **비싼 계산이 여러 component에서 사용된다면 re-render 마다 반복해서 실행될 수 있음**
     - 이 경우, profiling을 통해 정말로 비싼 계산인지 확인한 뒤 **필요한 경우에만 별도의 memoization을 구현**
- React compiler를 사용하더라도 memoization을 추가로 제어하기 위해(more control over memoization) `useMemo`, `useCallback`, `memo` 등 기존 memoization hooks를 사용할 수 있음
  - Effect를 의미 없이 재실행 시키지 않기 위해 dependency value를 memoize 하는 경우
- 새로운 코드는 compiler의 memoization을 사용하고, memoization을 더 정확하게 제어해야 할 때 `useMemo`, `useCallback` hook 사용
- 기존 코드에서는 memoization을 유지하거나 충분히 테스트 한 뒤 제거

## [React Compiler - Incremental Adoption](https://react.dev/learn/react-compiler/incremental-adoption)

- React compiler는 기존 코드에서 부분적으로 적용해 나갈 수 있음
- React compiler의 점진적 도입 접근 방법
  1. Babel overrides : compiler를 특정 directory에 부분 적용
  2. Opt-in with `"use memo"` : 명시적으로 특정 compoment만 compile
  3. Runtime gating : Feature flag를 통해 compilation 제어

### Directory-Based Adoption with Babel Overrides

```javascript
// babel.config.js
module.exports = {
  plugins: [],
  overrides: [
    {
      test: "./src/experimental/**/*.{js,jsx,ts,tsx}",
      plugins: [
        [
          "babel-plugin-react-compiler",
          {
            // options ...
          },
        ],
      ],
    },
    {
      test: "./src/production/**/*.{js,jsx,ts,tsx}",
      plugins: [
        [
          "babel-plugin-react-compiler",
          {
            // options ...
          },
        ],
      ],
    },
  ],
};
```

- `babel.config.js`에서 `overrides` option을 사용하여 특정 directory에 compiler plugin 적용

### Opt-In Mode with "use memo"

- React compiler를 전체 directory에 영향을 주지 않고 특정 compoment에만 테스트 할 수 있음
- `babel.config.js`에서 `compilationMode` plugin option을 `annotation`으로 설정
  ```javascript
  // babel.config.js
  module.exports = {
    plugins: [
      [
        "babel-plugin-react-compiler",
        {
          compilationMode: "annotation",
        },
      ],
    ],
  };
  ```
- `"use memo"` directive를 사용한 components 및 hooks만 compile
  ```javascript
  function TodoList({ todos }) {
    "use memo";
    // ...
  }
  ```

### Runtime Feature Flags with Gating

- Feature flag를 사용해서 React compiler를 runtime에 제어할 수 있음
  - A/B testing, compiler 점진적 배포 등에 활용 가능
- 동작 방식
  - Compiler는 runtime에 최적화된 코드를 wrap
  - Gate가 `true`를 반환하면 최적화된 코드를 사용하고, 그렇지 않으면 원래 코드를 사용
- `babel.config.js`에서 `gating` plugin option에 feature flag 설정
  ```javascript
  // babel.config.js
  module.exports = {
    plugins: [
      [
        "babel-plugin-react-compiler",
        {
          gating: {
            source: "ReactCompilerFeatureFlags",
            importSpecifierName: "isCompilerEnabled",
          },
        },
      ],
    ],
  };
  ```
- `babel.config.js` 설정에 따라 feature flag 구현
  ```javascript
  // ReactCompilerFeatureFlags.js
  export function isCompilerEnabled() {
    // Use your feature flag system
    return getFeatureFlag("react_compiler_enabled");
  }
  ```
